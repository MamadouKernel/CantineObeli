@model Obeli_K.Models.ViewModels.CommandeGroupeeViewModel

@{
    ViewData["Title"] = "Créer une Commande Groupée";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-users text-warning me-2"></i>
                        Créer une Commande Groupée
                    </h3>
                </div>
                <div class="card-body">
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-users me-2"></i>
                                        Commande Groupée - Groupes non-CIT (Quantité Libre)
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form asp-action="CreerCommandeGroupee" method="post">
                                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                                        
                                        <div class="row">
                                            <!-- Groupe non-CIT -->
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label asp-for="GroupeNonCitId" class="form-label">
                                                        <i class="fas fa-building me-1"></i>
                                                        Groupe non-CIT
                                                    </label>
                                                    <select asp-for="GroupeNonCitId" class="form-select" id="groupeSelect" asp-items="ViewBag.GroupesNonCit">
                                                        <option value="">-- Sélectionner un groupe --</option>
                                                    </select>
                                                    <span asp-validation-for="GroupeNonCitId" class="text-danger"></span>
                                                </div>
                                            </div>

                                            <!-- Date -->
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label asp-for="Date" class="form-label">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        Date de consommation
                                                    </label>
                                                    <input asp-for="Date" type="date" class="form-control" />
                                                    <span asp-validation-for="Date" class="text-danger"></span>
                                                </div>
                                            </div>

                                            <!-- Période de service -->
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label asp-for="PeriodeService" class="form-label">
                                                        <i class="fas fa-clock me-1"></i>
                                                        Période de service
                                                    </label>
                                                    <select asp-for="PeriodeService" class="form-select">
                                                        <option value="0">Jour</option>
                                                        <option value="1">Nuit</option>
                                                    </select>
                                                    <span asp-validation-for="PeriodeService" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Type de Formule -->
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label asp-for="TypeFormule" class="form-label">
                                                        <i class="fas fa-utensils me-1"></i>
                                                        Type de Formule
                                                    </label>
                                                    <select asp-for="TypeFormule" class="form-select" id="typeFormuleSelect">
                                                        <option value="">-- Sélectionner un type --</option>
                                                        <option value="Amélioré">Amélioré</option>
                                                        <option value="Standard 1">Standard 1</option>
                                                        <option value="Standard 2">Standard 2</option>
                                                    </select>
                                                    <span asp-validation-for="TypeFormule" class="text-danger"></span>
                                                </div>
                                            </div>

                                            <!-- Menu -->
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="IdFormule" class="form-label">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        Menu
                                                    </label>
                                                    <select asp-for="IdFormule" class="form-select" id="menuSelect">
                                                        <option value="">-- Sélectionner un menu --</option>
                                                    </select>
                                                    <span asp-validation-for="IdFormule" class="text-danger"></span>
                                                </div>
                                            </div>

                                            <!-- Quantité -->
                                            <div class="col-md-2">
                                                <div class="mb-3">
                                                    <label asp-for="Quantite" class="form-label">
                                                        <i class="fas fa-hashtag me-1"></i>
                                                        Quantité
                                                    </label>
                                                    <input asp-for="Quantite" class="form-control" type="number" min="1" max="1000" />
                                                    <span asp-validation-for="Quantite" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <!-- Site -->
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Site" class="form-label">
                                                        <i class="fas fa-map-marker-alt me-1"></i>
                                                        Site
                                                    </label>
                                                    <select asp-for="Site" class="form-select">
                                                        <option value="">-- Sélectionner --</option>
                                                        <option value="0">CIT Terminal</option>
                                                        <option value="1">CIT Billing</option>
                                                    </select>
                                                    <span asp-validation-for="Site" class="text-danger"></span>
                                                </div>
                                            </div>

                                            <!-- Commentaires -->
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label asp-for="Commentaires" class="form-label">
                                                        <i class="fas fa-comment me-1"></i>
                                                        Commentaires
                                                    </label>
                                                    <input asp-for="Commentaires" class="form-control" placeholder="Commentaires optionnels" />
                                                    <span asp-validation-for="Commentaires" class="text-danger"></span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Information compacte -->
                                        <div class="alert alert-light border-warning">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        <strong>Groupes non-CIT :</strong> Quantité libre (1-1000 plats)
                                                    </small>
                                                </div>
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        <strong>Menus :</strong> Semaine N+1 selon le type sélectionné
                                                    </small>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-between">
                                            <a asp-action="Index" class="btn btn-secondary">
                                                <i class="fas fa-arrow-left me-1"></i>
                                                Retour à la liste
                                            </a>
                                            <button type="submit" class="btn btn-warning">
                                                <i class="fas fa-users me-1"></i>
                                                Créer la commande groupée
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            // Charger les quotas quand un groupe est sélectionné
            $('#groupeSelect').change(function() {
                loadQuotaInfo();
            });

            // Charger les menus quand le type de formule change
            $('#typeFormuleSelect').change(function() {
                loadMenusForType();
            });

            // Charger les menus quand la date change
            $('#Date').change(function() {
                loadMenusForType();
            });

            // Charger les quotas au chargement initial
            loadQuotaInfo();
        });


        function loadMenusForType() {
            var typeFormule = $('#typeFormuleSelect').val();
            var date = $('#Date').val();
            
            // Vider le dropdown menu si l'un des champs requis n'est pas rempli
            if (!typeFormule || !date) {
                $('#menuSelect').empty().append('<option value="">-- Sélectionner un menu --</option>');
                return;
            }

            // Charger les menus via AJAX
            $.ajax({
                url: '@Url.Action("GetMenusByType", "Commande")',
                type: 'GET',
                data: {
                    typeFormule: typeFormule,
                    date: date
                },
                success: function(data) {
                    console.log('Menus reçus:', data);
                    var select = $('#menuSelect');
                    select.empty();
                    select.append('<option value="">-- Sélectionner un menu --</option>');
                    
                    if (data && data.length > 0) {
                        data.forEach(function(item) {
                            console.log('Ajout menu:', item.value, item.text);
                            select.append('<option value="' + item.value + '">' + item.text + '</option>');
                        });
                    } else {
                        console.log('Aucun menu trouvé pour le type:', typeFormule);
                        select.append('<option value="">Aucun menu disponible</option>');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Erreur lors du chargement des menus:', error);
                }
            });
        }

        function loadQuotaInfo() {
            var groupeId = $('#groupeSelect').val();
            var date = $('#Date').val();
            
            if (!groupeId || !date) {
                $('#quotaInfo').hide();
                return;
            }

            // Simulation des informations de quota (à remplacer par un appel AJAX réel)
            var quotaInfo = {
                quotaJour: 50,
                quotaNuit: 30,
                consommesJour: 20,
                consommesNuit: 10,
                restrictionStandard: true
            };

            var restantsJour = quotaInfo.quotaJour - quotaInfo.consommesJour;
            var restantsNuit = quotaInfo.quotaNuit - quotaInfo.consommesNuit;

            var html = '<div class="row">';
            html += '<div class="col-md-6">';
            html += '<strong>Service Jour:</strong> ' + restantsJour + ' plats disponibles (sur ' + quotaInfo.quotaJour + ')';
            html += '</div>';
            html += '<div class="col-md-6">';
            html += '<strong>Service Nuit:</strong> ' + restantsNuit + ' plats disponibles (sur ' + quotaInfo.quotaNuit + ')';
            html += '</div>';
            html += '</div>';
            
            if (quotaInfo.restrictionStandard) {
                html += '<div class="mt-2"><small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Ce groupe est restreint aux formules standard uniquement.</small></div>';
            }

            $('#quotaDetails').html(html);
            $('#quotaInfo').show();
        }
    </script>
}
