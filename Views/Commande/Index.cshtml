@model Obeli_K.Models.ViewModels.PagedViewModel<Obeli_K.Models.ViewModels.CommandeListViewModel>

@{
    ViewData["Title"] = "Liste des Commandes";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <!-- Header responsive -->
                <div class="card-header">
                    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
                        <div>
                            <h3 class="card-title mb-1">
                                <i class="fas fa-shopping-cart text-warning me-2"></i>
                                Liste des Commandes
                            </h3>
                            <p class="text-muted mb-0 small d-none d-sm-block">Gérer toutes les commandes du système</p>
                        </div>
                        
                        <!-- Actions mobile-first -->
                        <div class="d-flex flex-column flex-sm-row align-items-stretch align-items-sm-center gap-2 w-100 w-lg-auto">
                            <!-- Boutons principaux -->
                            <div class="btn-group w-100 w-sm-auto" role="group">
                                @if (!User.IsInRole("PrestataireCantine"))
                                {
                                    <a asp-action="Create" class="btn btn-warning">
                                        <i class="fas fa-plus me-1"></i>
                                        <span class="d-none d-sm-inline">Nouvelle </span>Commande
                                    </a>
                                }
                                <a asp-action="ExportExcel" 
                                   asp-route-status="@ViewBag.Status" 
                                   asp-route-dateDebut="@ViewBag.DateDebut" 
                                   asp-route-dateFin="@ViewBag.DateFin" 
                                   class="btn btn-success">
                                    <i class="fas fa-file-excel me-1"></i>
                                    <span class="d-none d-sm-inline">Export </span>Excel
                                </a>
                            </div>
                            
                            <!-- Sélecteur de taille - masqué sur mobile -->
                            <div class="d-none d-md-flex align-items-center">
                                <label for="pageSize" class="form-label me-2 mb-0 small text-nowrap">Par page:</label>
                                <select id="pageSize" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(this.value)">
                                    <option value="20" selected="@(Model.Pagination.PageSize == 20)">20</option>
                                    <option value="50" selected="@(Model.Pagination.PageSize == 50)">50</option>
                                    <option value="70" selected="@(Model.Pagination.PageSize == 70)">70</option>
                                    <option value="100" selected="@(Model.Pagination.PageSize == 100)">100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    @if (TempData["InfoMessage"] != null)
                    {
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            @TempData["InfoMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- Formulaire de filtrage -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-filter text-primary me-2"></i>
                                Filtres
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="date-filters-container">
                                <form method="get" class="row g-3 align-items-end">
                                    <input type="hidden" name="pageSize" value="@(ViewBag.PageSize ?? Model.Pagination.PageSize)" />
                                    <div class="col-md-2">
                                        <div class="date-input-container">
                                            <label for="dateDebut" class="form-label">
                                                <i class="fas fa-calendar-day"></i>
                                                Date de début
                                            </label>
                                            <input type="date" id="dateDebut" name="dateDebut" class="form-control" 
                                                   value="@ViewBag.DateDebut?.ToString("yyyy-MM-dd")" />
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="date-input-container">
                                            <label for="dateFin" class="form-label">
                                                <i class="fas fa-calendar-day"></i>
                                                Date de fin
                                            </label>
                                            <input type="date" id="dateFin" name="dateFin" class="form-control" 
                                                   value="@ViewBag.DateFin?.ToString("yyyy-MM-dd")" />
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="status" class="form-label">
                                            <i class="fas fa-filter"></i>
                                            Statut
                                        </label>
                                        <select id="status" name="status" class="form-select" style="border-radius: 12px; border: 2px solid #E5E5E5;">
                                            <option value="">Tous les statuts</option>
                                            @{
                                                var currentStatus = ViewBag.Status?.ToString();
                                            }
                                            <option value="Precommander" selected="@(currentStatus == "Precommander")">Précommandée</option>
                                            <option value="Consommee" selected="@(currentStatus == "Consommee")">Consommée</option>
                                            <option value="Annulee" selected="@(currentStatus == "Annulee")">Annulée</option>
                                            <option value="Indisponible" selected="@(currentStatus == "Indisponible")">Indisponible</option>
                                            <option value="NonRecuperer" selected="@(currentStatus == "NonRecuperer")">Non récupérée</option>
                                        </select>
                                    </div>
                                    @if (User.IsInRole("Administrateur") || User.IsInRole("RH"))
                                    {
                                        <div class="col-md-3">
                                            <label for="matricule" class="form-label">
                                                <i class="fas fa-user"></i>
                                                Matricule
                                            </label>
                                            <select id="matricule" name="matricule" class="form-select select2-search" 
                                                    style="border-radius: 12px; border: 2px solid #E5E5E5;" 
                                                    data-placeholder="Rechercher par matricule, nom ou prénom...">
                                                <option value="">Tous les utilisateurs</option>
                                                @if (!string.IsNullOrWhiteSpace(ViewBag.Matricule?.ToString()))
                                                {
                                                    <option value="@ViewBag.Matricule" selected>@ViewBag.Matricule</option>
                                                }
                                            </select>
                                        </div>
                                    }
                                    <div class="col-md-@(User.IsInRole("Administrateur") || User.IsInRole("RH") ? "3" : "6")">
                                        <div class="date-action-buttons">
                                            <button type="submit" class="btn-search">
                                                <i class="fas fa-search"></i>
                                                Rechercher
                                            </button>
                                            <a href="@Url.Action("Index")" class="btn-clear">
                                                <i class="fas fa-times"></i>
                                                Effacer
                                            </a>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    @if (Model != null && Model.Items != null && Model.Items.Any())
                    {
                        <!-- Vue Desktop - Tableau -->
                        <div class="d-none d-lg-block">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Code</th>
                                            <th>Date Consommation</th>
                                            <th>Client</th>
                                            <th>Formule</th>
                                            <th>Statut</th>
                                            <th>Période</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var commande in Model.Items)
                                        {
                                            <tr>
                                                <td>
                                                    <span class="badge bg-secondary">@commande.CodeCommande</span>
                                                </td>
                                                <td>@(commande.DateConsommation?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(commande.UtilisateurNomComplet))
                                                    {
                                                        <span class="text-primary">@commande.UtilisateurNomComplet</span>
                                                    }
                                                    else if (!string.IsNullOrEmpty(commande.GroupeNonCitNom))
                                                    {
                                                        <span class="text-info">@commande.GroupeNonCitNom</span>
                                                    }
                                                    else if (!string.IsNullOrEmpty(commande.VisiteurNom))
                                                    {
                                                        <span class="text-success">@commande.VisiteurNom</span>
                                                        @if (!string.IsNullOrEmpty(commande.VisiteurTelephone))
                                                        {
                                                            <br><small class="text-muted">@commande.VisiteurTelephone</small>
                                                        }
                                                    }
                                                </td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(commande.NomPlat))
                                                    {
                                                        <strong>@commande.NomPlat</strong>
                                                        @if (!string.IsNullOrEmpty(commande.TypeFormuleNom))
                                                        {
                                                            <br><small class="text-muted">@commande.TypeFormuleNom</small>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <strong>@commande.FormuleNom</strong>
                                                        @if (!string.IsNullOrEmpty(commande.TypeFormuleNom))
                                                        {
                                                            <br><small class="text-muted">@commande.TypeFormuleNom</small>
                                                        }
                                                    }
                                                </td>
                                                <td>
                                                    @switch (commande.StatusCommande)
                                                    {
                                                        case Obeli_K.Enums.StatutCommande.Precommander:
                                                            <span class="badge bg-warning">Précommandée</span>
                                                            break;
                                                        case Obeli_K.Enums.StatutCommande.Consommee:
                                                            <span class="badge bg-success">Consommée</span>
                                                            break;
                                                        case Obeli_K.Enums.StatutCommande.Annulee:
                                                            <span class="badge bg-danger">Annulée</span>
                                                            break;
                                                        case Obeli_K.Enums.StatutCommande.Indisponible:
                                                            <span class="badge bg-info">Indisponible</span>
                                                            break;
                                                        case Obeli_K.Enums.StatutCommande.NonRecuperer:
                                                            <span class="badge bg-secondary">Non récupérée</span>
                                                            break;
                                                        default:
                                                            <span class="badge bg-secondary">@commande.StatusCommande</span>
                                                            break;
                                                    }
                                                </td>
                                                <td>
                                                    @switch (commande.PeriodeService)
                                                    {
                                                        case Obeli_K.Enums.Periode.Jour:
                                                            <span class="badge bg-primary">Jour</span>
                                                            break;
                                                        case Obeli_K.Enums.Periode.Nuit:
                                                            <span class="badge bg-dark">Nuit</span>
                                                            break;
                                                        default:
                                                            <span class="badge bg-secondary">@commande.PeriodeService</span>
                                                            break;
                                                    }
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <a asp-action="Details" asp-route-id="@commande.IdCommande" 
                                                           class="btn btn-outline-info" title="Voir les détails">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        @* Boutons de modification uniquement pour RH et Admin sur les commandes non consommées *@
                                                        @if ((User.IsInRole("Administrateur") || User.IsInRole("RH")) && commande.StatusCommande != Obeli_K.Enums.StatutCommande.Consommee)
                                                        {
                                                            <a asp-action="Edit" asp-route-id="@commande.IdCommande" 
                                                               class="btn btn-outline-warning" title="Modifier">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            @if (commande.StatusCommande == Obeli_K.Enums.StatutCommande.Precommander)
                                                            {
                                                                <form asp-action="Delete" method="post" class="d-inline" 
                                                                      onsubmit="return confirm('Êtes-vous sûr de vouloir annuler cette commande ?');">
                                                                    <input type="hidden" name="id" value="@commande.IdCommande" />
                                                                    <button type="submit" class="btn btn-outline-danger" title="Annuler">
                                                                        <i class="fas fa-times"></i>
                                                                    </button>
                                                                </form>
                                                            }
                                                        }
                                                        @* Message informatif pour les commandes consommées *@
                                                        @if (commande.StatusCommande == Obeli_K.Enums.StatutCommande.Consommee)
                                                        {
                                                            <span class="text-muted small" title="Commande consommée - Lecture seule">
                                                                <i class="fas fa-lock me-1"></i>Lecture seule
                                                            </span>
                                                        }
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Vue Mobile - Cartes -->
                        <div class="d-lg-none">
                            <div class="row g-3">
                                @foreach (var commande in Model.Items)
                                {
                                    <div class="col-12">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-3">
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex flex-wrap gap-2 mb-2">
                                                            <span class="badge bg-secondary">@commande.CodeCommande</span>
                                                            @switch (commande.StatusCommande)
                                                            {
                                                                case Obeli_K.Enums.StatutCommande.Precommander:
                                                                    <span class="badge bg-warning">Précommandée</span>
                                                                    break;
                                                                case Obeli_K.Enums.StatutCommande.Consommee:
                                                                    <span class="badge bg-success">Consommée</span>
                                                                    break;
                                                                case Obeli_K.Enums.StatutCommande.Annulee:
                                                                    <span class="badge bg-danger">Annulée</span>
                                                                    break;
                                                                case Obeli_K.Enums.StatutCommande.Indisponible:
                                                                    <span class="badge bg-info">Indisponible</span>
                                                                    break;
                                                                case Obeli_K.Enums.StatutCommande.NonRecuperer:
                                                                    <span class="badge bg-secondary">Non récupérée</span>
                                                                    break;
                                                                default:
                                                                    <span class="badge bg-secondary">@commande.StatusCommande</span>
                                                                    break;
                                                            }
                                                            @switch (commande.PeriodeService)
                                                            {
                                                                case Obeli_K.Enums.Periode.Jour:
                                                                    <span class="badge bg-primary">Jour</span>
                                                                    break;
                                                                case Obeli_K.Enums.Periode.Nuit:
                                                                    <span class="badge bg-dark">Nuit</span>
                                                                    break;
                                                                default:
                                                                    <span class="badge bg-secondary">@commande.PeriodeService</span>
                                                                    break;
                                                            }
                                                        </div>
                                                        <h6 class="card-title mb-1">
                                                            @if (!string.IsNullOrEmpty(commande.NomPlat))
                                                            {
                                                                @commande.NomPlat
                                                            }
                                                            else
                                                            {
                                                                @commande.FormuleNom
                                                            }
                                                        </h6>
                                                        @if (!string.IsNullOrEmpty(commande.TypeFormuleNom))
                                                        {
                                                            <p class="text-muted small mb-2">@commande.TypeFormuleNom</p>
                                                        }
                                                    </div>
                                                    <div class="dropdown">
                                                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="dropdown">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </button>
                                                        <ul class="dropdown-menu dropdown-menu-end">
                                                            <li>
                                                                <a class="dropdown-item" asp-action="Details" asp-route-id="@commande.IdCommande">
                                                                    <i class="fas fa-eye me-2"></i>Détails
                                                                </a>
                                                            </li>
                                                            @if ((User.IsInRole("Administrateur") || User.IsInRole("RH")) && commande.StatusCommande != Obeli_K.Enums.StatutCommande.Consommee)
                                                            {
                                                                <li>
                                                                    <a class="dropdown-item" asp-action="Edit" asp-route-id="@commande.IdCommande">
                                                                        <i class="fas fa-edit me-2"></i>Modifier
                                                                    </a>
                                                                </li>
                                                                @if (commande.StatusCommande == Obeli_K.Enums.StatutCommande.Precommander)
                                                                {
                                                                    <li><hr class="dropdown-divider"></li>
                                                                    <li>
                                                                        <form asp-action="Delete" method="post" class="d-inline" 
                                                                              onsubmit="return confirm('Êtes-vous sûr de vouloir annuler cette commande ?');">
                                                                            <input type="hidden" name="id" value="@commande.IdCommande" />
                                                                            <button type="submit" class="dropdown-item text-danger">
                                                                                <i class="fas fa-times me-2"></i>Annuler
                                                                            </button>
                                                                        </form>
                                                                    </li>
                                                                }
                                                            }
                                                        </ul>
                                                    </div>
                                                </div>
                                                
                                                <div class="row g-2 text-sm">
                                                    <div class="col-6">
                                                        <small class="text-muted d-block">Date</small>
                                                        <span>@(commande.DateConsommation?.ToString("dd/MM/yyyy") ?? "N/A")</span>
                                                    </div>
                                                    <div class="col-6">
                                                        <small class="text-muted d-block">Client</small>
                                                        @if (!string.IsNullOrEmpty(commande.UtilisateurNomComplet))
                                                        {
                                                            <span class="text-primary">@commande.UtilisateurNomComplet</span>
                                                        }
                                                        else if (!string.IsNullOrEmpty(commande.GroupeNonCitNom))
                                                        {
                                                            <span class="text-info">@commande.GroupeNonCitNom</span>
                                                        }
                                                        else if (!string.IsNullOrEmpty(commande.VisiteurNom))
                                                        {
                                                            <span class="text-success">@commande.VisiteurNom</span>
                                                            @if (!string.IsNullOrEmpty(commande.VisiteurTelephone))
                                                            {
                                                                <br><small class="text-muted">@commande.VisiteurTelephone</small>
                                                            }
                                                        }
                                                    </div>
                                                </div>
                                                
                                                @if (commande.StatusCommande == Obeli_K.Enums.StatutCommande.Consommee)
                                                {
                                                    <div class="mt-2">
                                                        <small class="text-muted">
                                                            <i class="fas fa-lock me-1"></i>Commande consommée - Lecture seule
                                                        </small>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        @await Html.PartialAsync("_Pagination", Model.Pagination)

                        <!-- Bouton d'export Excel -->
                        <div class="d-flex justify-content-end mt-3">
                            <form asp-action="ExporterExcel" method="post" class="d-inline">
                                <input type="hidden" name="status" value="@ViewBag.Status" />
                                <input type="hidden" name="dateDebut" value="@ViewBag.DateDebut?.ToString("yyyy-MM-dd")" />
                                <input type="hidden" name="dateFin" value="@ViewBag.DateFin?.ToString("yyyy-MM-dd")" />
                                @if (User.IsInRole("Administrateur") || User.IsInRole("RH"))
                                {
                                    <input type="hidden" name="matricule" value="@ViewBag.Matricule" />
                                }
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-file-excel me-1"></i>
                                    Exporter en Excel
                                </button>
                            </form>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Aucune commande trouvée</h5>
                            <p class="text-muted">Il n'y a actuellement aucune commande à afficher.</p>
                            <a asp-action="Create" class="btn btn-warning">
                                <i class="fas fa-plus me-1"></i>
                                Créer une nouvelle commande
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="~/css/date-inputs.css" />
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <script>
        // Auto-dismiss alerts after 5 seconds
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 5000);
        
        // Fonction pour changer la taille de page
        function changePageSize(pageSize) {
            const url = new URL(window.location);
            url.searchParams.set('pageSize', pageSize);
            url.searchParams.set('page', '1'); // Retourner à la première page
            window.location.href = url.toString();
        }

        // Initialiser Select2 pour la recherche de matricule
        $(document).ready(function() {
            $('#matricule').select2({
                theme: 'bootstrap-5',
                placeholder: 'Rechercher par matricule, nom ou prénom...',
                allowClear: true,
                minimumInputLength: 2,
                language: {
                    inputTooShort: function() {
                        return 'Saisissez au moins 2 caractères';
                    },
                    noResults: function() {
                        return 'Aucun résultat trouvé';
                    },
                    searching: function() {
                        return 'Recherche en cours...';
                    }
                },
                ajax: {
                    url: '@Url.Action("SearchUsersByMatricule", "Commande")',
                    dataType: 'json',
                    delay: 300,
                    data: function(params) {
                        return {
                            term: params.term // terme de recherche
                        };
                    },
                    processResults: function(data) {
                        return {
                            results: data.map(function(item) {
                                return {
                                    id: item.matricule,
                                    text: item.text
                                };
                            })
                        };
                    },
                    cache: true
                }
            });

            // Pré-sélectionner la valeur si elle existe
            @if (!string.IsNullOrWhiteSpace(ViewBag.Matricule?.ToString()))
            {
                <text>
                var matriculeValue = '@ViewBag.Matricule';
                // Créer une option pour la valeur pré-sélectionnée
                var option = new Option(matriculeValue, matriculeValue, true, true);
                $('#matricule').append(option).trigger('change');
                </text>
            }
        });
    </script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
}
