@model Obeli_K.Models.ViewModels.PagedViewModel<object>

@{
    ViewData["Title"] = "Liste des Services";
}

<div class="container mt-4">
    <!-- Header responsive -->
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4 gap-3">
        <div>
            <h2 class="mb-1"><i class="bi bi-diagram-3"></i> Liste des Services</h2>
            <p class="text-muted mb-0 d-none d-sm-block">Gérer les services par direction</p>
        </div>
        <a href="@Url.Action("Create", "Service")" class="btn btn-success w-100 w-sm-auto">
            <i class="bi bi-plus-circle"></i> Nouveau Service
        </a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-body">
            @if (ViewBag.Services != null && ((IEnumerable<dynamic>)ViewBag.Services).Any())
            {
                <!-- Vue Desktop - Tableau -->
                <div class="d-none d-lg-block">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Nom</th>
                                    <th>Code</th>
                                    <th>Direction</th>
                                    <th>Responsable</th>
                                    <th>Email</th>
                                    <th>Utilisateurs</th>
                                    <th>Créé le</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var service in ViewBag.Services)
                                {
                                    <tr>
                                        <td>
                                            <strong>@service.Nom</strong>
                                            @if (!string.IsNullOrEmpty(service.Description))
                                            {
                                                <br /><small class="text-muted">@service.Description</small>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(service.Code))
                                            {
                                                <span class="badge bg-secondary">@service.Code</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (service.DirectionId != null)
                                            {
                                                <span class="badge bg-primary">@service.DirectionNom</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>@(service.Responsable ?? "-")</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(service.Email))
                                            {
                                                <a href="mailto:@service.Email">@service.Email</a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge bg-info">@service.NombreUtilisateurs utilisateur(s)</span>
                                        </td>
                                        <td>
                                            @if (service.CreatedOn != null)
                                            {
                                                @Convert.ToDateTime(service.CreatedOn).ToString("dd/MM/yyyy")
                                            }
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <a href="@Url.Action("Details", "Service", new { id = service.Id })" 
                                                   class="btn btn-sm btn-info" title="Détails">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <a href="@Url.Action("Edit", "Service", new { id = service.Id })" 
                                                   class="btn btn-sm btn-warning" title="Modifier">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-danger" 
                                                        onclick="confirmDelete('@service.Id', '@service.Nom')" title="Supprimer">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Vue Mobile - Cartes -->
                <div class="d-lg-none">
                    <div class="row g-3">
                        @foreach (var service in ViewBag.Services)
                        {
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div class="flex-grow-1">
                                                <h5 class="card-title mb-1">@service.Nom</h5>
                                                <div class="d-flex flex-wrap gap-2 mb-2">
                                                    @if (!string.IsNullOrEmpty(service.Code))
                                                    {
                                                        <span class="badge bg-secondary">@service.Code</span>
                                                    }
                                                    @if (service.DirectionId != null)
                                                    {
                                                        <span class="badge bg-primary">@service.DirectionNom</span>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(service.Description))
                                                {
                                                    <p class="text-muted small mb-2">@service.Description</p>
                                                }
                                            </div>
                                            <div class="dropdown">
                                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="dropdown">
                                                    <i class="bi bi-three-dots-vertical"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li>
                                                        <a class="dropdown-item" href="@Url.Action("Details", "Service", new { id = service.Id })">
                                                            <i class="bi bi-eye me-2"></i>Détails
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="@Url.Action("Edit", "Service", new { id = service.Id })">
                                                            <i class="bi bi-pencil me-2"></i>Modifier
                                                        </a>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <button class="dropdown-item text-danger" onclick="confirmDelete('@service.Id', '@service.Nom')">
                                                            <i class="bi bi-trash me-2"></i>Supprimer
                                                        </button>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <div class="row g-2 text-sm">
                                            @if (!string.IsNullOrEmpty(service.Responsable))
                                            {
                                                <div class="col-6">
                                                    <small class="text-muted d-block">Responsable</small>
                                                    <span>@service.Responsable</span>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(service.Email))
                                            {
                                                <div class="col-6">
                                                    <small class="text-muted d-block">Email</small>
                                                    <a href="mailto:@service.Email" class="text-decoration-none">@service.Email</a>
                                                </div>
                                            }
                                            <div class="col-6">
                                                <small class="text-muted d-block">Utilisateurs</small>
                                                <span class="badge bg-info">@service.NombreUtilisateurs</span>
                                            </div>
                                            @if (service.CreatedOn != null)
                                            {
                                                <div class="col-6">
                                                    <small class="text-muted d-block">Créé le</small>
                                                    <span>@Convert.ToDateTime(service.CreatedOn).ToString("dd/MM/yyyy")</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @if (Model.Pagination != null)
                {
                    <partial name="_Pagination" model="Model.Pagination" />
                }
            }
            else
            {
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-info-circle"></i> Aucun service trouvé.
                    <a href="@Url.Action("Create", "Service")" class="alert-link">Créer le premier service</a>
                </div>
            }
        </div>
    </div>
</div>

<form id="deleteForm" method="post" style="display: none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        function confirmDelete(id, nom) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer le service "${nom}" ?\n\nCette action est irréversible.`)) {
                const form = document.getElementById('deleteForm');
                form.action = '@Url.Action("Delete", "Service")/' + id;
                form.submit();
            }
        }
    </script>
}
