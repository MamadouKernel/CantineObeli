@model Obeli_K.Models.ViewModels.CreateUtilisateurViewModel
@{
    ViewData["Title"] = "Nouvel Utilisateur";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-1">
                        <i class="fas fa-user-plus me-2"></i>
                        Nouvel Utilisateur
                    </h2>
                    <p class="text-muted mb-0">
                        Créer un nouvel utilisateur dans le système
                    </p>
                </div>
                <div class="text-end">
                    <a href="@Url.Action("List")" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Retour à la liste
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 text-primary">
                        <i class="fas fa-user me-2"></i>
                        Informations de l'utilisateur
                    </h5>
                </div>
                <div class="card-body p-3 p-md-4">
                    <form asp-action="Create" method="post">
                        @Html.AntiForgeryToken()
                        
                        <div class="row g-3 g-md-4">
                            <!-- Informations personnelles -->
                            <div class="col-12">
                                <h6 class="text-primary mb-3 pb-2 border-bottom">
                                    <i class="fas fa-id-card me-2"></i>Informations personnelles
                                </h6>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="Nom" class="form-label fw-semibold">Nom *</label>
                                <input asp-for="Nom" class="form-control form-control-lg" placeholder="Entrez le nom" />
                                <span asp-validation-for="Nom" class="text-danger small"></span>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="Prenoms" class="form-label fw-semibold">Prénoms *</label>
                                <input asp-for="Prenoms" class="form-control form-control-lg" placeholder="Entrez les prénoms" />
                                <span asp-validation-for="Prenoms" class="text-danger small"></span>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="UserName" class="form-label fw-semibold">Matricule *</label>
                                <input asp-for="UserName" class="form-control form-control-lg" placeholder="Entrez le matricule" />
                                <span asp-validation-for="UserName" class="text-danger small"></span>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="CodeCommande" class="form-label fw-semibold">Code Commande</label>
                                <input asp-for="CodeCommande" class="form-control form-control-lg" placeholder="Code commande (optionnel)" />
                                <span asp-validation-for="CodeCommande" class="text-danger small"></span>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="Email" class="form-label fw-semibold">Email <small class="text-muted">(optionnel)</small></label>
                                <input asp-for="Email" type="email" class="form-control form-control-lg" placeholder="email@exemple.com" />
                                <span asp-validation-for="Email" class="text-danger small"></span>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="PhoneNumber" class="form-label fw-semibold">Téléphone <small class="text-muted">(optionnel)</small></label>
                                <input asp-for="PhoneNumber" class="form-control form-control-lg" placeholder="+225 XX XX XX XX" />
                                <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                            </div>
                            
                            <!-- Mot de passe -->
                            <div class="col-12">
                                <hr class="my-4">
                                <h6 class="text-primary mb-3 pb-2 border-bottom">
                                    <i class="fas fa-lock me-2"></i>Mot de passe
                                </h6>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="MotDePasse" class="form-label fw-semibold">Mot de passe *</label>
                                <div class="input-group">
                                    <input asp-for="MotDePasse" type="password" class="form-control form-control-lg" placeholder="Entrez le mot de passe" id="password1" />
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('password1', this)">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="MotDePasse" class="text-danger small"></span>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="ConfirmerMotDePasse" class="form-label fw-semibold">Confirmer le mot de passe *</label>
                                <div class="input-group">
                                    <input asp-for="ConfirmerMotDePasse" type="password" class="form-control form-control-lg" placeholder="Confirmez le mot de passe" id="password2" />
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('password2', this)">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="ConfirmerMotDePasse" class="text-danger small"></span>
                            </div>
                            
                            <!-- Rôle et affectation -->
                            <div class="col-12">
                                <hr class="my-4">
                                <h6 class="text-primary mb-3 pb-2 border-bottom">
                                    <i class="fas fa-user-tag me-2"></i>Rôle et affectation
                                </h6>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="Role" class="form-label fw-semibold">Rôle *</label>
                                <select asp-for="Role" class="form-select form-select-lg">
                                    <option value="">Sélectionnez un rôle</option>
                                    @if (ViewBag.Roles != null)
                                    {
                                        @foreach (var role in ViewBag.Roles)
                                        {
                                            <option value="@role.Value">@role.Text</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="Role" class="text-danger small"></span>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="DirectionId" class="form-label fw-semibold">Direction *</label>
                                <select asp-for="DirectionId" class="form-select form-select-lg" id="directionSelect">
                                    <option value="">Sélectionnez une direction</option>
                                    @if (ViewBag.Directions != null)
                                    {
                                        @foreach (var dir in ViewBag.Directions)
                                        {
                                            <option value="@dir.Value">@dir.Text</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="DirectionId" class="text-danger small"></span>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="ServiceId" class="form-label fw-semibold">Service <small class="text-muted">(optionnel)</small></label>
                                <select asp-for="ServiceId" class="form-select form-select-lg" id="serviceSelect">
                                    <option value="">Sélectionnez d'abord une direction</option>
                                </select>
                                <span asp-validation-for="ServiceId" class="text-danger small"></span>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="FonctionId" class="form-label fw-semibold">Fonction <small class="text-muted">(optionnel)</small></label>
                                <select asp-for="FonctionId" class="form-select form-select-lg">
                                    <option value="">Sélectionnez une fonction (optionnel)</option>
                                    @if (ViewBag.Fonctions != null)
                                    {
                                        @foreach (var fonction in ViewBag.Fonctions)
                                        {
                                            <option value="@fonction.Value">@fonction.Text</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="FonctionId" class="text-danger small"></span>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="Lieu" class="form-label fw-semibold">Lieu <small class="text-muted">(optionnel)</small></label>
                                <input asp-for="Lieu" class="form-control form-control-lg" placeholder="Lieu de travail" />
                                <span asp-validation-for="Lieu" class="text-danger small"></span>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <label asp-for="Site" class="form-label fw-semibold">Site <small class="text-muted">(optionnel)</small></label>
                                <select asp-for="Site" class="form-select form-select-lg">
                                    <option value="">Sélectionnez un site (optionnel)</option>
                                    <option value="0">CIT Terminal</option>
                                    <option value="1">CIT Billing</option>
                                </select>
                                <span asp-validation-for="Site" class="text-danger small"></span>
                            </div>
                        </div>
                        
                        <!-- Boutons d'action -->
                        <div class="row mt-4 pt-3 border-top">
                            <div class="col-12">
                                <div class="d-flex flex-column flex-sm-row justify-content-end gap-2">
                                    <a href="@Url.Action("List")" class="btn btn-secondary btn-lg order-2 order-sm-1">
                                        <i class="fas fa-times me-2"></i>Annuler
                                    </a>
                                    <button type="submit" class="btn btn-primary btn-lg order-1 order-sm-2">
                                        <i class="fas fa-save me-2"></i>Créer l'utilisateur
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Fonction pour afficher/masquer le mot de passe
        function togglePassword(inputId, button) {
            const passwordField = document.getElementById(inputId);
            const icon = button.querySelector('i');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                icon.className = 'bi bi-eye-slash';
            } else {
                passwordField.type = 'password';
                icon.className = 'bi bi-eye';
            }
        }
        
        // Charger les services quand une direction est sélectionnée
        document.getElementById('directionSelect').addEventListener('change', function() {
            const directionId = this.value;
            const serviceSelect = document.getElementById('serviceSelect');
            
            // Réinitialiser le select des services
            serviceSelect.innerHTML = '<option value="">Chargement...</option>';
            serviceSelect.disabled = true;
            
            if (!directionId) {
                serviceSelect.innerHTML = '<option value="">Sélectionnez d\'abord une direction</option>';
                return;
            }
            
            // Charger les services via API
            fetch(`/Service/GetServicesByDirection?directionId=${directionId}`)
                .then(response => response.json())
                .then(result => {
                    serviceSelect.innerHTML = '<option value="">Sélectionnez un service (optionnel)</option>';
                    
                    if (result.success && result.data && result.data.length > 0) {
                        result.data.forEach(service => {
                            const option = document.createElement('option');
                            option.value = service.id;
                            option.textContent = service.nom;
                            serviceSelect.appendChild(option);
                        });
                    } else {
                        serviceSelect.innerHTML += '<option value="" disabled>Aucun service disponible</option>';
                    }
                    
                    serviceSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des services:', error);
                    serviceSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                    serviceSelect.disabled = false;
                });
        });
    </script>
}
