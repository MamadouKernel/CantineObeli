@using System.Globalization
@{
    var fr = CultureInfo.GetCultureInfo("fr-FR");
    string? role = User?.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value;

    // Données communes (pour Admin/RH/Employé)
    var menusDyn = (IEnumerable<dynamic>)(ViewBag.MenuSemaineEnCours ?? Enumerable.Empty<dynamic>());
    var menus = menusDyn.ToList();
    var menusParDate = menus
        .GroupBy(m => ((DateTime)m.Date).Date)
        .OrderBy(g => g.Key)
        .ToList();

    var mesCmdsDyn = (IEnumerable<dynamic>)(ViewBag.MesCommandesSemaine ?? Enumerable.Empty<dynamic>());
    var mesCmds = mesCmdsDyn
        .OrderBy(c => (DateTime?)c.DateConsommation)
        .ThenBy(c => (DateTime)c.Date)
        .ToList();

    int nbCmd = (int)(ViewBag.NombreCommandes ?? mesCmds.Count);
}

<!-- ==================== VUE ADMIN / RH / EMPLOYÉ ==================== -->
@if (role != "PrestataireCantine")
{
    <div class="row">
        <!-- ========= Colonne gauche : Menus de la semaine ========= -->
        <div class="col-lg-9 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 text-primary">
                        <i class="fas fa-book-open me-2"></i>
                        Menus de la Semaine en cours
                    </h5>
                </div>
                <div class="card-body">
                    @if (!menus.Any())
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Aucun menu disponible pour cette semaine</h5>
                            <p class="text-muted">Les menus seront bientôt disponibles.</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var groupe in menusParDate)
                        {
                            var dateDuJour = groupe.Key;

                            // On n'affiche que les formules qui ont du contenu
                            var menusDuJour = groupe.Where(menu =>
                            {
                                string S(object? x) => x?.ToString() ?? "";
                                return !string.IsNullOrWhiteSpace(S(menu.Entree))
                                    || !string.IsNullOrWhiteSpace(S(menu.Plat))
                                    || !string.IsNullOrWhiteSpace(S(menu.Garniture))
                                    || !string.IsNullOrWhiteSpace(S(menu.Dessert))
                                    || !string.IsNullOrWhiteSpace(S(menu.PlatStandard1))
                                    || !string.IsNullOrWhiteSpace(S(menu.GarnitureStandard1))
                                    || !string.IsNullOrWhiteSpace(S(menu.PlatStandard2))
                                    || !string.IsNullOrWhiteSpace(S(menu.GarnitureStandard2))
                                    || !string.IsNullOrWhiteSpace(S(menu.Feculent))
                                    || !string.IsNullOrWhiteSpace(S(menu.Legumes));
                            })
                            .OrderBy(m => (string)(m.TypeFormule ?? ""))
                            .ThenBy(m => (string)(m.NomFormule ?? ""))
                            .ToList();

                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-calendar-day me-2"></i>
                                        @dateDuJour.ToString("dddd dd/MM/yyyy", fr)
                                    </h5>
                                </div>

                                <div class="card-body">
                                    @if (!menusDuJour.Any())
                                    {
                                        <div class="text-muted fst-italic">Aucun détail de menu pour ce jour.</div>
                                    }
                                    else
                                    {
                                        <div class="row g-3">
                                            @foreach (var menu in menusDuJour)
                                            {
                                                string titre = (string)(menu.TypeFormule ?? menu.NomFormule ?? "Formule");

                                                <div class="col-md-4">
                                                    <div class="card border-0 shadow-sm h-100">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                                <h6 class="card-title text-primary mb-0">@titre</h6>
                                                                <span class="badge bg-warning text-dark">
                                                                    @(((DateTime)menu.Date).ToString("dd/MM"))
                                                                </span>
                                                            </div>

                                                            @* Affichages simples, sans helper *@
                                                            @if (!string.IsNullOrWhiteSpace((string)(menu.Entree ?? "")))
                                                            {
                                                                <div class="menu-item">
                                                                    <i class="fas fa-leaf text-success me-2"></i><strong>Entrée :</strong> @menu.Entree
                                                                </div>
                                                            }
                                                            @if (!string.IsNullOrWhiteSpace((string)(menu.Plat ?? "")))
                                                            {
                                                                <div class="menu-item">
                                                                    <i class="fas fa-drumstick-bite me-2"></i><strong>Plat :</strong> @menu.Plat
                                                                </div>
                                                            }
                                                            @if (!string.IsNullOrWhiteSpace((string)(menu.Garniture ?? "")))
                                                            {
                                                                <div class="menu-item">
                                                                    <i class="fas fa-seedling me-2"></i><strong>Garniture :</strong> @menu.Garniture
                                                                </div>
                                                            }
                                                            @if (!string.IsNullOrWhiteSpace((string)(menu.Dessert ?? "")))
                                                            {
                                                                <div class="menu-item">
                                                                    <i class="fas fa-ice-cream me-2"></i><strong>Dessert :</strong> @menu.Dessert
                                                                </div>
                                                            }
                                                            @if (!string.IsNullOrWhiteSpace((string)(menu.PlatStandard1 ?? "")))
                                                            {
                                                                <div class="menu-item">
                                                                    <i class="fas fa-drumstick-bite me-2"></i><strong>Plat :</strong> @menu.PlatStandard1
                                                                </div>
                                                            }
                                                            @if (!string.IsNullOrWhiteSpace((string)(menu.GarnitureStandard1 ?? "")))
                                                            {
                                                                <div class="menu-item">
                                                                    <i class="fas fa-seedling me-2"></i><strong>Garniture :</strong> @menu.GarnitureStandard1
                                                                </div>
                                                            }
                                                            @if (!string.IsNullOrWhiteSpace((string)(menu.PlatStandard2 ?? "")))
                                                            {
                                                                <div class="menu-item">
                                                                    <i class="fas fa-drumstick-bite me-2"></i><strong>Plat :</strong> @menu.PlatStandard2
                                                                </div>
                                                            }
                                                            @if (!string.IsNullOrWhiteSpace((string)(menu.GarnitureStandard2 ?? "")))
                                                            {
                                                                <div class="menu-item">
                                                                    <i class="fas fa-seedling me-2"></i><strong>Garniture :</strong> @menu.GarnitureStandard2
                                                                </div>
                                                            }
                                                            @if (!string.IsNullOrWhiteSpace((string)(menu.Feculent ?? "")))
                                                            {
                                                                <div class="menu-item">
                                                                    <i class="fas fa-bread-slice me-2"></i><strong>Féculent :</strong> @menu.Feculent
                                                                </div>
                                                            }
                                                            @if (!string.IsNullOrWhiteSpace((string)(menu.Legumes ?? "")))
                                                            {
                                                                <div class="menu-item">
                                                                    <i class="fas fa-carrot text-success me-2"></i><strong>Légumes :</strong> @menu.Legumes
                                                                </div>
                                                            }

                                                            @{
                                                                bool rien =
                                                                    string.IsNullOrWhiteSpace((string)(menu.Entree ?? "")) &&
                                                                    string.IsNullOrWhiteSpace((string)(menu.Plat ?? "")) &&
                                                                    string.IsNullOrWhiteSpace((string)(menu.Garniture ?? "")) &&
                                                                    string.IsNullOrWhiteSpace((string)(menu.Dessert ?? "")) &&
                                                                    string.IsNullOrWhiteSpace((string)(menu.PlatStandard1 ?? "")) &&
                                                                    string.IsNullOrWhiteSpace((string)(menu.GarnitureStandard1 ?? "")) &&
                                                                    string.IsNullOrWhiteSpace((string)(menu.PlatStandard2 ?? "")) &&
                                                                    string.IsNullOrWhiteSpace((string)(menu.GarnitureStandard2 ?? "")) &&
                                                                    string.IsNullOrWhiteSpace((string)(menu.Feculent ?? "")) &&
                                                                    string.IsNullOrWhiteSpace((string)(menu.Legumes ?? ""));
                                                                if (rien)
                                                                {
                                                                    <div class="text-muted small fst-italic">Détails non saisis.</div>
                                                                }
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- ========= Colonne droite : Mes Commandes (semaine en cours) ========= -->
        <div class="col-lg-3 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-success">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Mes Commandes (@nbCmd)
                    </h5>
                    <span class="badge bg-light text-dark">
                        Semaine en cours
                    </span>
                </div>
                <div class="card-body">
                    @if (!mesCmds.Any())
                    {
                        <div class="text-center py-4">
                            <i class="fas fa-shopping-cart fa-2x text-muted mb-3"></i>
                            <h6 class="text-muted">Aucune commande cette semaine</h6>
                            <p class="small text-muted">Vos commandes apparaîtront ici.</p>
                        </div>
                    }
                    else
                    {
                        @* Groupé par jour de consommation — déclaration dans un bloc C# *@
                        var cmdsParJour = mesCmds
                            .GroupBy(c => ((DateTime?)c.DateConsommation)?.Date)
                            .OrderBy(g => g.Key)
                            .ToList();

                        @foreach (var g in cmdsParJour)
                        {
                            <div class="mb-3">
                                <div class="fw-semibold text-primary mb-2">
                                    <i class="fas fa-calendar-day me-1"></i>
                                    @(g.Key.HasValue ? g.Key.Value.ToString("dddd dd/MM", fr) : "Date non précisée")
                                </div>

                                @foreach (var c in g)
                                {
                                    int status = (int)c.StatusCommande; // 0=Précommandé, 1=Consommé, 2=Annulé
                                    string badge = status == 0 ? "bg-warning" : status == 1 ? "bg-success" : "bg-danger";
                                    string lib = status == 0 ? "Précommandé" : status == 1 ? "Consommé" : "Annulé";

                                    <div class="commande-item mb-2 p-3 border rounded-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                           @* <div class="small text-muted">
                                                Créée le @(((DateTime)c.Date).ToString("dd/MM HH:mm"))
                                            </div>*@
                                            <span class="badge @badge">@lib</span>
                                        </div> 

                                        <div class="commande-details">
                                            <p class="mb-1">
                                                <i class="fas fa-utensils me-2 text-primary"></i>
                                                <strong>@(c.FormuleJour?.NomFormule ?? "Formule")</strong>
                                            </p>

                                            @if (!string.IsNullOrWhiteSpace((string)(c.FormuleJour?.Plat ?? "")))
                                            { <p class="mb-1 small text-muted">@c.FormuleJour.Plat</p> }
                                            @if (!string.IsNullOrWhiteSpace((string)(c.FormuleJour?.PlatStandard1 ?? "")))
                                            { <p class="mb-1 small text-muted">@c.FormuleJour.PlatStandard1</p> }
                                            @if (!string.IsNullOrWhiteSpace((string)(c.FormuleJour?.PlatStandard2 ?? "")))
                                            { <p class="mb-1 small text-muted">@c.FormuleJour.PlatStandard2</p> }

                                            @* Si tu veux réafficher la quantité, dé-commente :
                                            <p class="mb-0">
                                                <i class="fas fa-hashtag me-2 text-info"></i>
                                                Quantité: <strong>@c.Quantite</strong>
                                            </p>
                                            *@
                                        </div>

                                        @if (status == 2 && !string.IsNullOrWhiteSpace((string)(c.MotifAnnulation ?? "")))
                                        {
                                            <div class="mt-2 p-2 bg-light rounded">
                                                <small class="text-muted">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                                    <strong>Motif:</strong> @c.MotifAnnulation
                                                </small>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- ==================== VUE PRESTATAIRE ==================== -->
@{
    var prestataireMenusDyn = (IEnumerable<dynamic>)(ViewBag.MenusDuJour ?? Enumerable.Empty<dynamic>());
    var prestataireMenus = prestataireMenusDyn.ToList();
    var prestataireCommandesDyn = (IEnumerable<dynamic>)(ViewBag.CommandesDuJour ?? Enumerable.Empty<dynamic>());
    var prestataireCommandes = prestataireCommandesDyn.ToList();
    var prestataireDate = (DateTime)(ViewBag.DateAujourdhui ?? DateTime.Today);
    var prestataireNombreCommandes = (int)(ViewBag.NombreCommandes ?? 0);
    var prestataireCommandesParFormule = (Dictionary<string, int>)(ViewBag.CommandesParFormule ?? new Dictionary<string, int>());
}

@if (role == "PrestataireCantine")
{

    <div class="row">
        <!-- ========= Colonne gauche : Menus du jour ========= -->
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-warning text-dark border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-utensils me-2"></i>
                        Menus du Jour - @prestataireDate.ToString("dddd dd MMMM yyyy", fr)
                    </h5>
                </div>
                <div class="card-body">
                    @if (!prestataireMenus.Any())
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Aucun menu disponible pour aujourd'hui</h5>
                            <p class="text-muted">Les menus seront bientôt disponibles.</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var menu in prestataireMenus)
                        {
                            <div class="card mb-3 border-warning">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0 text-warning">
                                        <i class="fas fa-star me-2"></i>
                                        @menu.TypeFormule - @menu.NomFormule
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-primary">Plats :</h6>
                                            <ul class="list-unstyled">
                                                @if (!string.IsNullOrEmpty(menu.Plat?.ToString()))
                                                {
                                                    <li><i class="fas fa-check text-success me-2"></i>@menu.Plat</li>
                                                }
                                                @if (!string.IsNullOrEmpty(menu.PlatStandard1?.ToString()))
                                                {
                                                    <li><i class="fas fa-check text-success me-2"></i>@menu.PlatStandard1</li>
                                                }
                                                @if (!string.IsNullOrEmpty(menu.PlatStandard2?.ToString()))
                                                {
                                                    <li><i class="fas fa-check text-success me-2"></i>@menu.PlatStandard2</li>
                                                }
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-primary">Accompagnements :</h6>
                                            <ul class="list-unstyled">
                                                
                                                @if (menu.TypeFormule?.ToString() == "Amélioré")
                                                {
                                                    @* Pour Amélioré : afficher entrée, dessert, etc. *@
                                                    @if (!string.IsNullOrEmpty(menu.Entree?.ToString()))
                                                    {
                                                        <li><i class="fas fa-leaf text-success me-2"></i>@menu.Entree</li>
                                                    }
                                                    @if (!string.IsNullOrEmpty(menu.Dessert?.ToString()))
                                                    {
                                                        <li><i class="fas fa-leaf text-success me-2"></i>@menu.Dessert</li>
                                                    }
                                                    @if (!string.IsNullOrEmpty(menu.Legumes?.ToString()))
                                                    {
                                                        <li><i class="fas fa-leaf text-success me-2"></i>@menu.Legumes</li>
                                                    }
                                                    @if (!string.IsNullOrEmpty(menu.Feculent?.ToString()))
                                                    {
                                                        <li><i class="fas fa-leaf text-success me-2"></i>@menu.Feculent</li>
                                                    }
                                                }
                                                else
                                                {
                                                    @* Pour Standard 1 et Standard 2 : afficher les garnitures *@
                                                    @if (!string.IsNullOrEmpty(menu.Garniture?.ToString()))
                                                    {
                                                        <li><i class="fas fa-leaf text-success me-2"></i>@menu.Garniture</li>
                                                        <li><i class="fas fa-leaf text-success me-2"></i>@menu.Entree</li>
                                                        <li><i class="fas fa-leaf text-success me-2"></i>@menu.Dessert</li>
                                                        <li><i class="fas fa-leaf text-success me-2"></i>@menu.Legumes</li>
                                                        <li><i class="fas fa-leaf text-success me-2"></i>@menu.Feculent</li>
                                                    }
                                                    @if (!string.IsNullOrEmpty(menu.GarnitureStandard1?.ToString()))
                                                    {
                                                        <li><i class="fas fa-leaf text-success me-2"></i>@menu.GarnitureStandard1</li>
                                                    }
                                                    @if (!string.IsNullOrEmpty(menu.GarnitureStandard2?.ToString()))
                                                    {
                                                        <li><i class="fas fa-leaf text-success me-2"></i>@menu.GarnitureStandard2</li>
                                                    }
                                                }
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- ========= Colonne droite : Statistiques par menu ========= -->
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-info text-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Statistiques par Menu
                    </h5>
                </div>
                <div class="card-body">
                    @if (!prestataireMenus.Any())
                    {
                        <div class="text-center py-4">
                            <i class="fas fa-utensils fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">Aucun menu disponible pour aujourd'hui</p>
                        </div>
                    }
                    else
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var menu in prestataireMenus)
                            {
                                var commandesMenu = prestataireCommandes.Where(c => c.FormuleNom?.ToString() == menu.NomFormule?.ToString()).ToList();
                                var commandesJour = commandesMenu.Count(c => c.PeriodeService?.ToString() == "Jour");
                                var commandesNuit = commandesMenu.Count(c => c.PeriodeService?.ToString() == "Nuit");
                                var margeMenu = menu.Marge ?? 0;
                                <div class="list-group-item border-0 px-0 mb-3">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">
                                                <i class="fas fa-star me-2"></i>
                                                @menu.TypeFormule - @menu.NomFormule
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row text-center">
                                                <div class="col-4">
                                                    <div class="border-end">
                                                        <h6 class="text-primary mb-1">Jour</h6>
                                                        <span class="badge bg-primary fs-6">@commandesJour</span>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="border-end">
                                                        <h6 class="text-dark mb-1">Nuit</h6>
                                                        <span class="badge bg-dark fs-6">@commandesNuit</span>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <h6 class="text-success mb-1">Marge</h6>
                                                    <span class="badge bg-success fs-6">@margeMenu</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}